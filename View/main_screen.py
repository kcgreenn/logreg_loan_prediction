# -*- coding: utf-8 -*-

# Form implementation generated from reading ui file '.\View\main_screen.ui'
#
# Created by: PyQt5 UI code generator 5.15.4
#
# WARNING: Any manual changes made to this file will be lost when pyuic5 is
# run again.  Do not edit this file unless you know what you are doing.

from joblib import load
from PyQt5 import QtCore, QtGui, QtWidgets
from PyQt5.QtWidgets import QStyleFactory
from PyQt5.QtChart import QChart, QChartView, QBarSet, QBarSeries, QBarCategoryAxis

from Model import Data
from Model import LogReg
from View import prog_bar
from View import new_loan_dialog
from View import data_viz_dialog
from View import model_stats


class Ui_MainWindow(object):
    def setupUi(self, MainWindow):
        self.filepath = './dummied_sba.csv'
        self.data = Data.Data(self.filepath)
        self.lr = LogReg.LogRegModel()
        self.trained_skl_model = load('./filename.joblib')
        self.lr.set_lr_model(self.trained_skl_model)

        MainWindow.setObjectName("MainWindow")
        MainWindow.resize(680, 350)
        self.centralwidget = QtWidgets.QWidget(MainWindow)
        self.centralwidget.setObjectName("centralwidget")
        self.centralwidget.setStyle(QStyleFactory.create('fusion'))
        self.centralwidget.setStyleSheet('background:#f7f7f7')
        self.pushButton = QtWidgets.QPushButton(self.centralwidget)
        self.pushButton.setGeometry(QtCore.QRect(400, 90, 181, 31))
        font = QtGui.QFont()
        font.setPointSize(12)
        self.pushButton.setFont(font)
        self.pushButton.setObjectName("new_loan_btn")
        self.pushButton.setStyleSheet('background:#0275d8;color:#f7f7f7')
        self.pushButton.setStyle(QStyleFactory.create('Windows'))
        self.pushButton.clicked.connect(self.handle_new_loan_click)
        self.pushButton_2 = QtWidgets.QPushButton(self.centralwidget)
        self.pushButton_2.setGeometry(QtCore.QRect(400, 160, 181, 31))
        self.pushButton_2.setStyle(QStyleFactory.create('Windows'))
        self.pushButton_2.setStyleSheet('background:#0275d8;color:#f7f7f7')
        self.pushButton_2.clicked.connect(self.handle_data_viz_click)
        font = QtGui.QFont()
        font.setPointSize(12)
        self.pushButton_2.setFont(font)
        self.pushButton_2.setObjectName("data_viz_btn")
        self.pushButton_3 = QtWidgets.QPushButton(self.centralwidget)
        self.pushButton_3.setGeometry(QtCore.QRect(400, 230, 181, 31))
        self.pushButton_3.setStyle(QStyleFactory.create('Windows'))
        self.pushButton_3.setStyleSheet('background:#0275d8;color:#f7f7f7')
        self.pushButton_3.clicked.connect(self.handle_model_stats_btn)
        font = QtGui.QFont()
        font.setPointSize(12)
        self.pushButton_3.setFont(font)
        self.pushButton_3.setObjectName("model_stats_btn")
        self.label = QtWidgets.QLabel(self.centralwidget)
        self.label.setGeometry(QtCore.QRect(20, 10, 201, 21))
        font = QtGui.QFont()
        font.setPointSize(16)
        self.label.setFont(font)
        self.label.setObjectName("label")
        MainWindow.setCentralWidget(self.centralwidget)
        self.menubar = QtWidgets.QMenuBar(MainWindow)
        self.menubar.setGeometry(QtCore.QRect(0, 0, 800, 21))
        self.menubar.setObjectName("menubar")
        MainWindow.setMenuBar(self.menubar)
        self.statusbar = QtWidgets.QStatusBar(MainWindow)
        self.statusbar.setObjectName("statusbar")
        MainWindow.setStatusBar(self.statusbar)
        self.chart = QChart()
        self.chartview = QChartView(self.chart, self.centralwidget)
        self.chartview.setGeometry(QtCore.QRect(20, 50, 320, 280))

        self.retranslateUi(MainWindow)
        QtCore.QMetaObject.connectSlotsByName(MainWindow)

    def retranslateUi(self, MainWindow):
        _translate = QtCore.QCoreApplication.translate
        MainWindow.setWindowTitle(_translate("MainWindow", "MainWindow"))
        self.pushButton.setText(_translate("MainWindow", "Get Loan Prediction"))
        self.pushButton_2.setText(_translate("MainWindow", "View Data Visualizations"))
        self.pushButton_3.setText(_translate("MainWindow", "View Model Statistics"))
        self.label.setText(_translate("MainWindow", "SBA Loan Program"))

    # Load data from csv file for regression model.
    def load_data(self):
        prog_dlg = prog_bar.ProgDialog(self.data, self.lr)
        prog_dlg.load_data()
        prog_dlg.exec()
        self.find_overall_stats()

    def handle_new_loan_click(self):
        new_loan_dlg = new_loan_dialog.New_Loan_Dlg(self.data, self.lr)
        new_loan_dlg.exec()

    def handle_data_viz_click(self):
        data_viz_dlg = data_viz_dialog.Ui_Dialog(self.data)
        data_viz_dlg.exec()

    def handle_model_stats_btn(self):
        mdl_stats = model_stats.Ui_Dialog(self.data, self.lr)
        mdl_stats.exec()

    def create_2set_chart(self, set0Title, set0, set1Title, set1, title, categories):
        self.set0 = QBarSet(set0Title)
        self.set1 = QBarSet(set1Title)

        for item in set0:
            self.set0 << item

        for item in set1:
            self.set1 << item

        self.series = QBarSeries()
        self.series.append(self.set0)
        self.series.append(self.set1)

        self.chart.addSeries(self.series)
        self.chart.setTitle(title)
        self.chart.setAnimationOptions(QChart.SeriesAnimations)

        categories = categories
        self.axis = QBarCategoryAxis()
        self.axis.append(categories)
        self.chart.createDefaultAxes()
        self.chart.setAxisX(self.axis, self.series)

    def find_overall_stats(self):
        data = self.data.get_data()
        count_chgoff = len(data[data['MIS_Status_P I F'] == 0])
        count_pif = len(data[data['MIS_Status_P I F'] == 1])
        pct_chgoff = count_chgoff / (count_chgoff + count_pif)
        pct_pif = count_pif / (count_chgoff + count_pif)

        self.create_2set_chart('ChgOff', [pct_chgoff * 100], 'P I F', [pct_pif * 100], 'Loan Chargeoffs vs Paid in Full',
                               [''])
